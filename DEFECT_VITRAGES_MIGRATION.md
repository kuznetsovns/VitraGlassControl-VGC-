# –ú–∏–≥—Ä–∞—Ü–∏—è –Ω–∞ –Ω–æ–≤—É—é —Ç–∞–±–ª–∏—Ü—É defect_vitrages

## –ß—Ç–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å

–°–æ–∑–¥–∞–Ω–∞ –æ—Ç–¥–µ–ª—å–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ **`defect_vitrages`** —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ –¥–ª—è –¥–µ—Ñ–µ–∫—Ç–æ–≤–∫–∏ –≤–∏—Ç—Ä–∞–∂–µ–π. –≠—Ç–æ –±–æ–ª–µ–µ –ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞:

- **`placed_vitrages`** - –¥–ª—è —Ä–∞–∑–º–µ—â–µ–Ω–∏—è –≤–∏—Ç—Ä–∞–∂–µ–π –Ω–∞ –ø–ª–∞–Ω–∞—Ö —ç—Ç–∞–∂–µ–π
- **`defect_vitrages`** - –¥–ª—è –¥–µ—Ñ–µ–∫—Ç–æ–≤–∫–∏ –≤–∏—Ç—Ä–∞–∂–µ–π —Å –Ω–∞–∑–Ω–∞—á–µ–Ω–Ω—ã–º–∏ ID

## –ö–∞–∫ –ø—Ä–∏–º–µ–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è

### 1. –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é –≤ Supabase

1. –û—Ç–∫—Ä–æ–π—Ç–µ Supabase Dashboard
2. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ **SQL Editor**
3. –û—Ç–∫—Ä–æ–π—Ç–µ —Ñ–∞–π–ª `supabase/migrations/009_create_defect_vitrages_table.sql`
4. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ
5. –í—Å—Ç–∞–≤—å—Ç–µ –≤ SQL Editor
6. –ù–∞–∂–º–∏—Ç–µ **Run**

### 2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã

1. –í Supabase Dashboard –ø–µ—Ä–µ–π–¥–∏—Ç–µ –≤ **Table Editor**
2. –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ —Ç–∞–±–ª–∏—Ü–∞ `defect_vitrages` —Å–æ–∑–¥–∞–Ω–∞
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Ç–∞–±–ª–∏—Ü—ã:
   - `id` - UUID (primary key)
   - `object_id` - UUID (foreign key to objects)
   - `placed_vitrage_id` - UUID (optional link to placed_vitrages)
   - `vitrage_id`, `vitrage_name`, `vitrage_data` - –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≤–∏—Ç—Ä–∞–∂–µ
   - `id_object`, `id_corpus`, ... - 8-–∫–æ–º–ø–æ–Ω–µ–Ω—Ç–Ω—ã–π ID
   - `full_id` - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º—ã–π –ø–æ–ª–Ω—ã–π ID
   - `segment_defects` - JSONB —Å –¥–µ—Ñ–µ–∫—Ç–∞–º–∏
   - `inspection_status`, `inspector_name`, `supervisor_name` - –¥–∞–Ω–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏

### 3. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ

```bash
# –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ç–µ–∫—É—â–∏–π dev-—Å–µ—Ä–≤–µ—Ä (Ctrl+C)
npm run dev
```

## –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞

### –ü—Ä–∏ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–∏ ID –≤–∏—Ç—Ä–∞–∂—É:

1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ä–∞–∑–º–µ—â–∞–µ—Ç –≤–∏—Ç—Ä–∞–∂ –Ω–∞ –ø–ª–∞–Ω–µ —ç—Ç–∞–∂–∞
2. –ù–∞–∂–∏–º–∞–µ—Ç "üÜî –ó–∞–¥–∞—Ç—å ID —Å–µ–∫—Ü–∏–π"
3. –ó–∞–ø–æ–ª–Ω—è–µ—Ç 8 –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ ID
4. –ù–∞–∂–∏–º–∞–µ—Ç "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤—Å–µ ID"

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:**
- –í–∏—Ç—Ä–∞–∂ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ `placed_vitrages` (–¥–ª—è –ø–ª–∞–Ω–∞ —ç—Ç–∞–∂–∞)
- ID —Å–µ–≥–º–µ–Ω—Ç–æ–≤ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ `vitrage_segment_ids`
- **–°–æ–∑–¥–∞–µ—Ç—Å—è –∑–∞–ø–∏—Å—å –≤ `defect_vitrages`** (–¥–ª—è –¥–µ—Ñ–µ–∫—Ç–æ–≤–∫–∏)

### –ü—Ä–∏ —Ä–∞–±–æ—Ç–µ —Å –¥–µ—Ñ–µ–∫—Ç–∞–º–∏:

1. –í–∫–ª–∞–¥–∫–∞ "–î–µ—Ñ–µ–∫—Ç–æ–≤–∫–∞" –∑–∞–≥—Ä—É–∂–∞–µ—Ç –≤–∏—Ç—Ä–∞–∂–∏ –∏–∑ **`defect_vitrages`**
2. –ü—Ä–∏ –∑–∞–¥–∞–Ω–∏–∏ –¥–µ—Ñ–µ–∫—Ç–∞ —Å–µ–≥–º–µ–Ω—Ç—É - –¥–µ—Ñ–µ–∫—Ç —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ **`defect_vitrages`**
3. –í—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ä–∞–∑—É –≤–∏–¥–Ω—ã –≤–æ –≤–∫–ª–∞–¥–∫–µ "–î–µ—Ñ–µ–∫—Ç–æ–≤–∫–∞"

## –ß—Ç–æ –ù–ï –Ω—É–∂–Ω–æ –¥–µ–ª–∞—Ç—å

‚ùå **–ù–ï –Ω—É–∂–Ω–æ** –º–∏–≥—Ä–∏—Ä–æ–≤–∞—Ç—å —Å—Ç–∞—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ `placed_vitrages`
‚úÖ –ü—Ä–æ—Å—Ç–æ –Ω–∞–∑–Ω–∞—á—å—Ç–µ ID –≤–∏—Ç—Ä–∞–∂–∞–º –∑–∞–Ω–æ–≤–æ - –æ–Ω–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–ø–∞–¥—É—Ç –≤ `defect_vitrages`

## –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏

### 1. –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ ID

```
1. –ü–ª–∞–Ω —ç—Ç–∞–∂–µ–π ‚Üí –í—ã–±—Ä–∞—Ç—å –≤–∏—Ç—Ä–∞–∂
2. –ù–∞–∂–∞—Ç—å "üÜî –ó–∞–¥–∞—Ç—å ID —Å–µ–∫—Ü–∏–π"
3. –ó–∞–ø–æ–ª–Ω–∏—Ç—å –≤—Å–µ –ø–æ–ª—è
4. –ù–∞–∂–∞—Ç—å "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤—Å–µ ID"
5. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–Ω—Å–æ–ª—å:
   ‚úÖ Vitrage ID saved to Supabase
   ‚úÖ Segment IDs saved to Supabase
   ‚úÖ Vitrage added to defect tracking
```

### 2. –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤ –¥–µ—Ñ–µ–∫—Ç–æ–≤–∫–µ

```
1. –ü–µ—Ä–µ–π—Ç–∏ –Ω–∞ –≤–∫–ª–∞–¥–∫—É "–î–µ—Ñ–µ–∫—Ç–æ–≤–∫–∞"
2. –í—ã–±—Ä–∞—Ç—å –æ–±—ä–µ–∫—Ç
3. –î–æ–ª–∂–Ω—ã –æ—Ç–æ–±—Ä–∞–∑–∏—Ç—å—Å—è –≤–∏—Ç—Ä–∞–∂–∏ —Å ID
4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–Ω—Å–æ–ª—å:
   üîç Loading defect vitrages for object: uuid
   üì¶ Loaded N defect vitrages from Supabase
   üéØ –ó–∞–≥—Ä—É–∂–µ–Ω–æ N –≤–∏—Ç—Ä–∞–∂–µ–π –¥–ª—è –¥–µ—Ñ–µ–∫—Ç–æ–≤–∫–∏ –∏–∑ Supabase
```

### 3. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–µ—Ñ–µ–∫—Ç–æ–≤

```
1. –ö–ª–∏–∫–Ω—É—Ç—å –Ω–∞ –∫–∞—Ä—Ç–æ—á–∫—É –≤–∏—Ç—Ä–∞–∂–∞
2. –í—ã–±—Ä–∞—Ç—å —Å–µ–≥–º–µ–Ω—Ç
3. –ó–∞–¥–∞—Ç—å –¥–µ—Ñ–µ–∫—Ç
4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–Ω—Å–æ–ª—å:
   üîß Updating segment defects for defect vitrage: uuid
   üìä Defects count: X defects in Y segments
   ‚úÖ Updated defects for defect vitrage uuid
```

### 4. –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤ Supabase Dashboard

```
1. Table Editor ‚Üí defect_vitrages
2. –î–æ–ª–∂–Ω—ã –±—ã—Ç—å –∑–∞–ø–∏—Å–∏ —Å:
   - full_id (–Ω–∞–ø—Ä–∏–º–µ—Ä: "–ó–∏–ª18-–ö–æ—Ä–ø—É—Å–ê-–°–µ–∫—Ü–∏—è1-2-101-1-–í-01")
   - segment_defects (JSONB —Å –¥–µ—Ñ–µ–∫—Ç–∞–º–∏)
   - total_defects_count (–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–µ—Ñ–µ–∫—Ç–æ–≤)
   - inspection_status (—Å—Ç–∞—Ç—É—Å –ø—Ä–æ–≤–µ—Ä–∫–∏)
```

## –õ–æ–≥–∏ –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏

–ü—Ä–∏ –≤–æ–∑–Ω–∏–∫–Ω–æ–≤–µ–Ω–∏–∏ –ø—Ä–æ–±–ª–µ–º –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞ (F12):

**–£—Å–ø–µ—à–Ω–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ:**
```
‚úÖ Vitrage ID saved to Supabase
‚úÖ Segment IDs saved to Supabase
üíæ Upserting defect vitrage: –ù–∞–∑–≤–∞–Ω–∏–µ
‚úÖ Defect vitrage created: uuid
‚úÖ Vitrage added to defect tracking
```

**–£—Å–ø–µ—à–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞:**
```
üîç Loading defect vitrages for object: uuid
üì¶ Loaded 5 defect vitrages from Supabase
üéØ –ó–∞–≥—Ä—É–∂–µ–Ω–æ 5 –≤–∏—Ç—Ä–∞–∂–µ–π –¥–ª—è –¥–µ—Ñ–µ–∫—Ç–æ–≤–∫–∏ –∏–∑ Supabase
```

**–£—Å–ø–µ—à–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–µ—Ñ–µ–∫—Ç–æ–≤:**
```
üîß Updating segment defects for defect vitrage: uuid
üìã Segment defects: {...}
üìä Defects count: 3 defects in 2 segments
‚úÖ Updated defects for defect vitrage uuid: 3 defects in 2 segments
```

## Troubleshooting

### –í–∏—Ç—Ä–∞–∂–∏ –Ω–µ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –≤ –¥–µ—Ñ–µ–∫—Ç–æ–≤–∫–µ

**–ü—Ä–æ–±–ª–µ–º–∞:** –í–∫–ª–∞–¥–∫–∞ "–î–µ—Ñ–µ–∫—Ç–æ–≤–∫–∞" –ø—É—Å—Ç–∞—è
**–†–µ—à–µ–Ω–∏–µ:**
1. –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ –º–∏–≥—Ä–∞—Ü–∏—è 009 –ø—Ä–∏–º–µ–Ω–µ–Ω–∞
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ –≤–∏—Ç—Ä–∞–∂–∞–º –Ω–∞–∑–Ω–∞—á–µ–Ω—ã ID
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å –Ω–∞ –æ—à–∏–±–∫–∏
4. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ Table Editor ‚Üí defect_vitrages

### –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ ID

**–ü—Ä–æ–±–ª–µ–º–∞:** `Error saving to defect_vitrages`
**–†–µ—à–µ–Ω–∏–µ:**
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ –º–∏–≥—Ä–∞—Ü–∏—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∞
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ object_id —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ —Ç–∞–±–ª–∏—Ü–µ objects
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ RLS –ø–æ–ª–∏—Ç–∏–∫–∏ –≤ Supabase

### –î–µ—Ñ–µ–∫—Ç—ã –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è

**–ü—Ä–æ–±–ª–µ–º–∞:** –î–µ—Ñ–µ–∫—Ç—ã –Ω–µ –ø–æ—è–≤–ª—è—é—Ç—Å—è –ø–æ—Å–ª–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
**–†–µ—à–µ–Ω–∏–µ:**
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å –Ω–∞ –æ—à–∏–±–∫–∏ `updateSegmentDefects`
2. –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ –≤–∏—Ç—Ä–∞–∂ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ defect_vitrages
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ Table Editor ‚Üí defect_vitrages

## –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –Ω–æ–≤–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã

‚úÖ **–†–∞–∑–¥–µ–ª–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏:**
- `placed_vitrages` - —Ç–æ–ª—å–∫–æ –¥–ª—è –ø–ª–∞–Ω–æ–≤ —ç—Ç–∞–∂–µ–π
- `defect_vitrages` - —Ç–æ–ª—å–∫–æ –¥–ª—è –¥–µ—Ñ–µ–∫—Ç–æ–≤–∫–∏

‚úÖ **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:**
- –í–∫–ª–∞–¥–∫–∞ "–î–µ—Ñ–µ–∫—Ç–æ–≤–∫–∞" –∑–∞–≥—Ä—É–∂–∞–µ—Ç —Ç–æ–ª—å–∫–æ –Ω—É–∂–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
- –ù–µ—Ç —Å–º–µ—à–∏–≤–∞–Ω–∏—è –≤–∏—Ç—Ä–∞–∂–µ–π –±–µ–∑ ID

‚úÖ **–ì–∏–±–∫–æ—Å—Ç—å:**
- –ú–æ–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å –¥–µ—Ñ–µ–∫—Ç–æ–≤–∫—É –±–µ–∑ —Ä–∞–∑–º–µ—â–µ–Ω–∏—è –Ω–∞ –ø–ª–∞–Ω–µ
- –ú–æ–∂–Ω–æ —Ä–∞–∑–º–µ—Å—Ç–∏—Ç—å –≤–∏—Ç—Ä–∞–∂ –±–µ–∑ –¥–µ—Ñ–µ–∫—Ç–æ–≤–∫–∏

‚úÖ **–¶–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö:**
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è —á–µ—Ä–µ–∑ RLS
- Foreign keys –¥–ª—è —Å–≤—è–∑–µ–π —Å objects –∏ placed_vitrages
